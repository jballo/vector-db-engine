# Vector DB Engine

A FastAPI service that lets users create, read, update, and delete document libraries and perform k-Nearest Neighbor vector search. Packaged as a Docker image and deployed via Helm into Kubernetes.

## Table of Contents

1. [Prerequisites](#prerequisites)  
2. [Local Development](#local-development)  
3. [Docker](#docker)  
4. [Kubernetes + Helm Deployment](#kubernetes--helm-deployment)  
5. [Rotating the API Key](#rotating-the-api-key)  
6. [Cleanup](#cleanup)  
7. [Project Structure](#project-structure)  
8. [License](#license)  

---

## Prerequisites

- Git  
- Python 3.11  
- Docker & Docker Desktop (with Kubernetes enabled)  
- kubectl CLI (configured to talk to your local cluster)  
- Helm 3  

Verify your setup:

```bash
python3 --version
docker --version
kubectl version --client
helm version
```


## Local Development

1. Clone & set up a virtual environment
    ```bash
    git clone https://github.com/jballo/vector-db-engine.git
    cd vector-db-engine
    python3 -m venv .venv
    source .venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt
    ```

2. Set your API key
    ```bash
    export API_KEY=superSecretKey
    ```

3. Run the FastAPI app locally
    ``` bash
    uvicorn app.main:app --reload --port 8000
    ```
    In another shell:
    ```bash
    curl -H "X-Key: $API_KEY" http://localhost:8000/health
    # → {"status":"ok"}
    ```
    Browse the OpenAPI docs at http://localhost:8000/docs

## Docker

1. Build the Docker image and push
    ```bash
    export IMAGE=yourdockerid/vector-db-engine
    export TAG=0.1.0

    docker build --pull --rm \
    -t $IMAGE:$TAG \
    -t $IMAGE:latest \
    .
    ```

    ```bash
    docker push $IMAGE:$TAG
    docker push $IMAGE:latest
    ```

2. Run the container
    ```bash
    docker run --rm \
    -e API_KEY=$API_KEY \
    -p 8000:8000 \
    $IMAGE:$TAG
    ```

    Test
    ```bash
    export REAL_API_KEY=<api key generated by uuigen>
    curl -X GET "http://localhost:8000/health" \
    -H "X-Key: $REAL_API_KEY"
    # → {"status":"ok"}
    ```


## Kubernetes + Helm Deployment

We inject the API key at runtime via a pre-created Kubernetes Secret.

1. Create the namespace
    ```bash
    kubectl create namespace vector-db-engine \
    --dry-run=client -o yaml \
    | kubectl apply -f -
    ```

2. Create or update the API key Secret
    ```bash
    export REAL_API_KEY=<api key generated by uuigen>
    export COHERE_API_KEY=<cohere_key>
    kubectl create secret generic vector-db-engine-secret \
    --from-literal=API_KEY="$REAL_API_KEY" \
    --from-literal=COHERE_KEY="$COHERE_API_KEY" \
    -n vector-db-engine \
    --dry-run=client -o yaml \
    | kubectl apply -f -
    ```

3. Deploy with Helm
    ```bash
    export TAG=0.1.0

    helm upgrade --install vector-db-engine \
    ./vector-db-engine-chart \
    --namespace vector-db-engine \
    --set image.repository=yourdockerid/vector-db-engine \
    --set image.tag=$TAG \
    --set existingSecret=true
    ```

4. Access the service
    In one terminal:
    ```bash
    kubectl port-forward svc/vector-db-engine 8000:80 \
    -n vector-db-engine
    ```

    In another:
    ```bash
    export REAL_API_KEY=<api key generated by uuigen>
    curl -X GET "http://localhost:8000/health" \
    -H "X-Key: $REAL_API_KEY"
        # → {"status":"ok"}
    ```


## Rotating the API Key
1. Update the Secret
    ```bash
    export REAL_API_KEY=<api key generated by uuigen>
    export COHERE_API_KEY=<cohere_key>
    kubectl create secret generic vector-db-engine-secret \
    --from-literal=API_KEY="$REAL_API_KEY" \
    --from-literal=COHERE_KEY="$COHERE_API_KEY" \
    -n vector-db-engine \
    --dry-run=client -o yaml \
    | kubectl apply -f -
    ```

2. Restart your Pods
    ```bash
    kubectl rollout restart deployment/vector-db-engine \
    -n vector-db-engine
    ```


## Project Structure
.
├── app
│   ├── __init__.py
│   ├── config.py
│   ├── dependencies.py
│   ├── main.py
│   ├── models
│   │   ├── chunk.py
│   │   ├── document.py
│   │   ├── library.py
│   │   └── search.py
│   ├── routers
│   │   ├── __init__.py
│   │   ├── chunks.py
│   │   ├── documents.py
│   │   ├── health.py
│   │   └── libraries.py
│   ├── service
│   │   ├── chunk_service.py
│   │   ├── document_service.py
│   │   ├── library_service.py
│   │   └── search_service.py
│   ├── store
│   │   └── in_memory.py
│   └── utils
│       └── knn.py
├── Dockerfile
├── LICENSE
├── README.md
├── requirements.txt
└── vector-db-engine-chart
    ├── Chart.yaml
    ├── charts
    ├── templates
    │   ├── _helpers.tpl
    │   ├── deployment.yaml
    │   └── service.yaml
    └── values.yaml
